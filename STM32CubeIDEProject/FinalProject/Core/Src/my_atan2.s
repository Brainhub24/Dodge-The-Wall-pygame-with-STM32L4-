.section .data
.align 4
    @ Use a larger table with more entries
    @.float 0.0, 0.7854, 1.10715, 1.24905, 1.32582, 1.3734, 1.40565, 1.4289, 1.44644, 1.46014, 1.47113, 1.48014, 1.48766, 1.49402, 1.49949, 1.50423, 1.50838, 1.51204, 1.5153, 1.51821, 1.52084, 1.52321, 1.52537, 1.52735, 1.52915, 1.53082, 1.53235, 1.53378, 1.5351, 1.53633, 1.53748, 1.53855, 1.53956, 1.5405, 1.54139, 1.54223, 1.54303, 1.54378, 1.54449, 1.54516, 1.5458, 1.54641, 1.54699, 1.54754, 1.54807, 1.54858, 1.54906, 1.54952, 1.54997, 1.55039, 1.5508, 1.55119, 1.55157, 1.55193, 1.55228, 1.55262, 1.55294, 1.55325, 1.55356, 1.55385, 1.55413, 1.5544, 1.55467, 1.55492, 1.55517, 1.55541, 1.55565, 1.55587, 1.55609, 1.5563, 1.55651, 1.55671, 1.55691, 1.5571, 1.55728, 1.55746, 1.55764, 1.55781, 1.55798, 1.55814, 1.5583, 1.55845, 1.5586, 1.55875, 1.55889, 1.55903, 1.55917, 1.5593, 1.55943, 1.55956, 1.55969, 1.55981, 1.55993, 1.56004, 1.56016, 1.56027, 1.56038, 1.56049, 1.56059, 1.5607, 1.5608, 1.5609, 1.56099, 1.56109, 1.56118, 1.56127, 1.56136, 1.56145, 1.56154, 1.56162, 1.56171, 1.56179, 1.56187, 1.56195, 1.56202, 1.5621, 1.56218, 1.56225, 1.56232, 1.56239, 1.56246, 1.56253, 1.5626, 1.56267, 1.56273, 1.5628, 1.56286, 1.56292, 1.56298, 1.56304, 1.5631, 1.56316, 1.56322, 1.56328, 1.56333, 1.56339, 1.56344, 1.5635, 1.56355, 1.5636, 1.56365, 1.5637, 1.56375, 1.5638, 1.56385, 1.5639, 1.56395, 1.56399, 1.56404, 1.56409, 1.56413, 1.56417, 1.56422, 1.56426, 1.5643, 1.56434, 1.56439, 1.56443, 1.56447, 1.56451, 1.56455, 1.56459, 1.56462, 1.56466, 1.5647, 1.56474, 1.56477, 1.56481, 1.56484, 1.56488, 1.56491, 1.56495, 1.56498, 1.56502, 1.56505, 1.56508, 1.56511, 1.56515, 1.56518, 1.56521, 1.56524, 1.56527, 1.5653, 1.56533, 1.56536, 1.56539, 1.56542, 1.56545, 1.56548, 1.56551, 1.56553, 1.56556, 1.56559, 1.56562, 1.56564, 1.56567, 1.56569, 1.56572, 1.56575, 1.56577, 1.5658, 1.56582, 1.56585, 1.56587, 1.56589, 1.56592, 1.56594, 1.56597, 1.56599, 1.56601, 1.56603, 1.56606, 1.56608, 1.5661, 1.56612, 1.56615, 1.56617, 1.56619, 1.56621, 1.56623, 1.56625, 1.56627, 1.56629, 1.56631, 1.56633, 1.56635, 1.56637, 1.56639, 1.56641, 1.56643, 1.56645, 1.56647, 1.56649, 1.5665, 1.56652, 1.56654, 1.56656, 1.56658, 1.56659, 1.56661, 1.56663, 1.56665, 1.56666, 1.56668, 1.5667, 1.56671, 1.56673, 1.56675, 1.56676, 1.56678, 1.5668, 1.56681, 1.56683, 1.56684, 1.56686, 1.56687, 1.56689, 1.56691, 1.56692, 1.56694, 1.56695, 1.56696, 1.56698, 1.56699, 1.56701, 1.56702, 1.56704, 1.56705, 1.56707, 1.56708, 1.56709, 1.56711, 1.56712, 1.56713, 1.56715, 1.56716, 1.56717, 1.56719, 1.5672, 1.56721, 1.56722, 1.56724, 1.56725, 1.56726, 1.56728, 1.56729, 1.5673, 1.56731, 1.56732, 1.56734, 1.56735, 1.56736, 1.56737, 1.56738, 1.56739, 1.56741, 1.56742, 1.56743, 1.56744, 1.56745, 1.56746, 1.56747, 1.56749, 1.5675, 1.56751, 1.56752, 1.56753, 1.56754, 1.56755, 1.56756, 1.56757, 1.56758, 1.56759, 1.5676, 1.56761, 1.56762, 1.56763, 1.56764, 1.56765, 1.56766, 1.56767, 1.56768, 1.56769, 1.5677, 1.56771, 1.56772, 1.56773, 1.56774, 1.56775, 1.56776, 1.56777, 1.56778, 1.56778, 1.56779, 1.5678, 1.56781, 1.56782, 1.56783, 1.56784, 1.56785, 1.56786, 1.56786, 1.56787, 1.56788, 1.56789, 1.5679, 1.56791, 1.56791, 1.56792, 1.56793, 1.56794, 1.56795, 1.56796, 1.56796, 1.56797, 1.56798, 1.56799, 1.568, 1.568, 1.56801, 1.56802, 1.56803, 1.56803, 1.56804, 1.56805, 1.56806, 1.56806, 1.56807, 1.56808, 1.56809, 1.56809, 1.5681, 1.56811, 1.56812, 1.56812, 1.56813, 1.56814, 1.56814, 1.56815, 1.56816, 1.56816, 1.56817, 1.56818, 1.56819, 1.56819, 1.5682, 1.56821, 1.56821, 1.56822, 1.56823, 1.56823, 1.56824, 1.56825, 1.56825, 1.56826, 1.56826, 1.56827, 1.56828, 1.56828, 1.56829, 1.5683, 1.5683, 1.56831, 1.56831, 1.56832, 1.56833, 1.56833, 1.56834, 1.56835, 1.56835, 1.56836, 1.56836, 1.56837, 1.56838, 1.56838, 1.56839, 1.56839, 1.5684, 1.5684, 1.56841, 1.56842, 1.56842, 1.56843, 1.56843, 1.56844, 1.56844, 1.56845, 1.56845, 1.56846, 1.56847, 1.56847, 1.56848, 1.56848, 1.56849, 1.56849, 1.5685, 1.5685, 1.56851, 1.56851, 1.56852, 1.56852, 1.56853, 1.56853, 1.56854, 1.56854, 1.56855, 1.56855, 1.56856, 1.56856, 1.56857, 1.56857, 1.56858, 1.56858, 1.56859, 1.56859, 1.5686, 1.5686, 1.56861, 1.56861, 1.56862, 1.56862, 1.56863, 1.56863, 1.56864, 1.56864, 1.56865, 1.56865, 1.56866, 1.56866, 1.56866, 1.56867, 1.56867, 1.56868, 1.56868, 1.56869, 1.56869, 1.5687, 1.5687, 1.5687, 1.56871, 1.56871, 1.56872, 1.56872, 1.56873, 1.56873, 1.56873, 1.56874, 1.56874, 1.56875, 1.56875, 1.56876, 1.56876, 1.56876, 1.56877, 1.56877, 1.56878, 1.56878, 1.56878, 1.56879, 1.56879, 1.5688, 1.5688, 1.5688, 1.56881, 1.56881, 1.56882, 1.56882, 1.56882, 1.56883, 1.56883, 1.56884, 1.56884, 1.56884, 1.56885, 1.56885, 1.56885, 1.56886, 1.56886, 1.56887, 1.56887, 1.56887, 1.56888, 1.56888, 1.56888, 1.56889, 1.56889, 1.5689, 1.5689, 1.5689, 1.56891, 1.56891, 1.56891, 1.56892, 1.56892, 1.56892, 1.56893, 1.56893, 1.56893, 1.56894, 1.56894, 1.56894, 1.56895, 1.56895, 1.56895, 1.56896, 1.56896, 1.56896, 1.56897, 1.56897, 1.56897, 1.56898, 1.56898, 1.56898, 1.56899, 1.56899, 1.56899, 1.569, 1.569, 1.569, 1.56901, 1.56901, 1.56901, 1.56902, 1.56902, 1.56902, 1.56903, 1.56903, 1.56903, 1.56904, 1.56904, 1.56904, 1.56905, 1.56905, 1.56905, 1.56905, 1.56906, 1.56906, 1.56906, 1.56907, 1.56907, 1.56907, 1.56908, 1.56908, 1.56908, 1.56908, 1.56909, 1.56909, 1.56909, 1.5691, 1.5691, 1.5691, 1.5691, 1.56911, 1.56911, 1.56911, 1.56912, 1.56912, 1.56912, 1.56912, 1.56913, 1.56913, 1.56913, 1.56914, 1.56914, 1.56914, 1.56914, 1.56915, 1.56915, 1.56915, 1.56915, 1.56916, 1.56916, 1.56916, 1.56917, 1.56917, 1.56917, 1.56917, 1.56918, 1.56918, 1.56918, 1.56918, 1.56919, 1.56919, 1.56919, 1.56919, 1.5692, 1.5692, 1.5692, 1.5692, 1.56921, 1.56921, 1.56921, 1.56921, 1.56922, 1.56922, 1.56922, 1.56922, 1.56923, 1.56923, 1.56923, 1.56923, 1.56924, 1.56924, 1.56924, 1.56924, 1.56925, 1.56925, 1.56925, 1.56925, 1.56926, 1.56926, 1.56926, 1.56926, 1.56926, 1.56927, 1.56927, 1.56927, 1.56927, 1.56928, 1.56928, 1.56928, 1.56928, 1.56929, 1.56929, 1.56929, 1.56929, 1.56929, 1.5693, 1.5693, 1.5693, 1.5693, 1.56931, 1.56931, 1.56931, 1.56931, 1.56931, 1.56932, 1.56932, 1.56932, 1.56932, 1.56933, 1.56933, 1.56933, 1.56933, 1.56933, 1.56934, 1.56934, 1.56934, 1.56934, 1.56934, 1.56935, 1.56935, 1.56935, 1.56935, 1.56936, 1.56936, 1.56936, 1.56936, 1.56936, 1.56937, 1.56937, 1.56937, 1.56937, 1.56937, 1.56938, 1.56938, 1.56938, 1.56938, 1.56938, 1.56939, 1.56939, 1.56939, 1.56939, 1.56939, 1.5694, 1.5694, 1.5694, 1.5694, 1.5694, 1.56941, 1.56941, 1.56941, 1.56941, 1.56941, 1.56942, 1.56942, 1.56942, 1.56942, 1.56942, 1.56942, 1.56943, 1.56943, 1.56943, 1.56943, 1.56943, 1.56944, 1.56944, 1.56944, 1.56944, 1.56944, 1.56944, 1.56945, 1.56945, 1.56945, 1.56945, 1.56945, 1.56946, 1.56946, 1.56946, 1.56946, 1.56946, 1.56946, 1.56947, 1.56947, 1.56947, 1.56947, 1.56947, 1.56948, 1.56948, 1.56948, 1.56948, 1.56948, 1.56948, 1.56949, 1.56949, 1.56949, 1.56949, 1.56949, 1.56949, 1.5695, 1.5695, 1.5695, 1.5695, 1.5695, 1.5695, 1.56951, 1.56951, 1.56951, 1.56951, 1.56951, 1.56951, 1.56952, 1.56952, 1.56952, 1.56952, 1.56952, 1.56952, 1.56953, 1.56953, 1.56953, 1.56953, 1.56953, 1.56953, 1.56954, 1.56954, 1.56954, 1.56954, 1.56954, 1.56954, 1.56954, 1.56955, 1.56955, 1.56955, 1.56955, 1.56955, 1.56955, 1.56956, 1.56956, 1.56956, 1.56956, 1.56956, 1.56956, 1.56956, 1.56957, 1.56957, 1.56957, 1.56957, 1.56957, 1.56957, 1.56958, 1.56958, 1.56958, 1.56958, 1.56958, 1.56958, 1.56958, 1.56959, 1.56959, 1.56959, 1.56959, 1.56959, 1.56959, 1.56959, 1.5696, 1.5696, 1.5696, 1.5696, 1.5696, 1.5696, 1.5696, 1.56961, 1.56961, 1.56961, 1.56961, 1.56961, 1.56961, 1.56961, 1.56962, 1.56962, 1.56962, 1.56962, 1.56962, 1.56962, 1.56962, 1.56963, 1.56963, 1.56963, 1.56963, 1.56963, 1.56963, 1.56963, 1.56963, 1.56964, 1.56964, 1.56964, 1.56964, 1.56964, 1.56964, 1.56964, 1.56965, 1.56965, 1.56965, 1.56965, 1.56965, 1.56965, 1.56965, 1.56965, 1.56966, 1.56966, 1.56966, 1.56966, 1.56966, 1.56966, 1.56966, 1.56967, 1.56967, 1.56967, 1.56967, 1.56967, 1.56967, 1.56967, 1.56967, 1.56968, 1.56968, 1.56968, 1.56968, 1.56968, 1.56968, 1.56968, 1.56968, 1.56969, 1.56969, 1.56969, 1.56969, 1.56969, 1.56969, 1.56969, 1.56969, 1.5697, 1.5697, 1.5697, 1.5697, 1.5697, 1.5697, 1.5697, 1.5697, 1.5697, 1.56971, 1.56971, 1.56971, 1.56971, 1.56971, 1.56971, 1.56971, 1.56971, 1.56972, 1.56972, 1.56972, 1.56972, 1.56972, 1.56972, 1.56972, 1.56972, 1.56972, 1.56973, 1.56973, 1.56973, 1.56973, 1.56973, 1.56973, 1.56973, 1.56973, 1.56973, 1.56974, 1.56974, 1.56974, 1.56974, 1.56974, 1.56974, 1.56974, 1.56974, 1.56974, 1.56975, 1.56975, 1.56975, 1.56975, 1.56975, 1.56975, 1.56975, 1.56975, 1.56975, 1.56976, 1.56976, 1.56976, 1.56976, 1.56976, 1.56976, 1.56976, 1.56976, 1.56976, 1.56977, 1.56977, 1.56977, 1.56977, 1.56977, 1.56977, 1.56977, 1.56977, 1.56977, 1.56977, 1.56978, 1.56978, 1.56978, 1.56978, 1.56978, 1.56978, 1.56978, 1.56978, 1.56978, 1.56979, 1.56979, 1.56979, 1.56979, 1.56979, 1.56979, 1.56979, 1.56979, 1.56979, 1.56979, 1.5698, 1.5698
lookup:
.float 0.0, 0.0099, 0.0198, 0.02969, 0.03958, 0.04946, 0.05934, 0.0692, 0.07904, 0.08887, 0.09869, 0.10848, 0.11826, 0.12801, 0.13774, 0.14744, 0.15711, 0.16675, 0.17637, 0.18595, 0.19549, 0.205, 0.21447, 0.2239, 0.2333, 0.24265, 0.25196, 0.26122, 0.27044, 0.27961, 0.28873, 0.2978, 0.30683, 0.3158, 0.32472, 0.33358, 0.3424, 0.35115, 0.35986, 0.3685, 0.37709, 0.38562, 0.39409, 0.4025, 0.41085, 0.41914, 0.42737, 0.43554, 0.44365, 0.4517, 0.45968, 0.4676, 0.47546, 0.48325, 0.49098, 0.49865, 0.50626, 0.5138, 0.52128, 0.52869, 0.53604, 0.54333, 0.55055, 0.55771, 0.5648, 0.57184, 0.57881, 0.58571, 0.59256, 0.59934, 0.60606, 0.61272, 0.61931, 0.62585, 0.63232, 0.63873, 0.64508, 0.65137, 0.65761, 0.66378, 0.66989, 0.67595, 0.68194, 0.68788, 0.69376, 0.69959, 0.70536, 0.71107, 0.71672, 0.72232, 0.72787, 0.73336, 0.7388, 0.74418, 0.74952, 0.7548, 0.76002, 0.7652, 0.77032, 0.7754, 0.78042

limit: .float 100.0
PI: .float 3.1415926
half_PI: .float 1.57
zero: .float 0.0
.section .text
.global my_atan2
my_atan2:
@input s0: x_cor
@input s1: y_cor
@output r0: pointer to result
	PUSH {r4-r7}
	LDR r3, =limit
	vldr.f32 s2, [r3] @limit
	vdiv.f32 s3, s0, s1
	vmul.f32 s3, s3, s2 @ratio
	vcmp.f32 s3, s2
	VMRS APSR_nzvc, FPSCR
	BGT ceiling
	vneg.f32 s2, s2
	vcmp.f32 s3, s2
	VMRS APSR_nzvc, FPSCR
	blt floor
	B calc
ceiling:
	vmov.f32 s3, s2
floor:
	vmov.f32 s3, s2
calc:
	vcmp.f32 s1, #0.0
	VMRS APSR_nzvc, FPSCR
	BGT case1
	BLT case2
	BEQ case3
case1:
	vcvt.s32.f32 s3, s3
	vmov r4, s3
	LDR r3, =zero
	vldr.f32 s5, [r3]
	B arctan_lookup
case2:
	vcmp.f32 s0, #0.0
	VMRS APSR_nzvc, FPSCR
	bge case2_1
	blt case2_2
case2_1:
	vcvt.s32.f32 s3, s3
	vmov r4, s3
	LDR r3, =PI
	vldr.f32 s5, [r3]
	B arctan_lookup
case2_2:
	vcvt.s32.f32 s3, s3
	vmov r4, s3
	LDR r3, =PI
	vldr.f32 s5, [r3]
	vneg.f32 s5, s5
	B arctan_lookup
case3:
	vcmp.f32 s0, #0.0
	VMRS APSR_nzvc, FPSCR
	bgt case3_1
	blt case3_2
	beq case3_3
case3_1:
	LDR r3, =half_PI
	vldr.f32 s4, [r3]
	B done
case3_2:
	LDR r3, =half_PI
	vldr.f32 s4, [r3]
	vneg.f32 s4, s4
	B done
case3_3:
	LDR r3, =zero
	vldr.f32 s4, [r3]
	B done
arctan_lookup:
	ldr r2, =lookup
	mov r7, #0
    cmp r4, r7
    blt negative
    mov r6, #4
    mul r6,r6,r4
    add r2, r2, r6
    vldr.f32 s4, [r2]
    vadd.f32 s4, s4, s5
    B done
negative:
	sub r4, r7, r4
	mov r6,#4
    mul r6,r6,r4
    add r2, r2, r6
    vldr.f32 s4, [r2]
	vneg.f32 s4, s4
	vadd.f32 s4, s4, s5
done:
	VSTR.F32 s4, [r0]
    pop {r4-r7}
    BX LR
